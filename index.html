<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Moxon Antenna Calculator</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            padding: 40px;
            max-width: 1500px;
            width: 100%;
        }

        h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 28px;
        }

        .subtitle {
            color: #666;
            margin-bottom: 10px;
            font-size: 14px;
        }

        .source-link {
            color: #666;
            margin-bottom: 30px;
            font-size: 12px;
        }

        .source-link a {
            color: #667eea;
            text-decoration: none;
        }

        .source-link a:hover {
            text-decoration: underline;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 500;
        }

        input[type="number"],
        select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        input[type="number"]:focus,
        select:focus {
            outline: none;
            border-color: #667eea;
        }

        .radio-group {
            display: flex;
            gap: 20px;
            margin-top: 8px;
        }

        .radio-option {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        input[type="radio"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .radio-option label {
            margin: 0;
            cursor: pointer;
            font-weight: normal;
        }

        button {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            margin-top: 10px;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        button:active {
            transform: translateY(0);
        }

        .results {
            margin-top: 30px;
            padding: 25px;
            background: #f8f9fa;
            border-radius: 12px;
            display: none;
        }

        .results.show {
            display: block;
        }

        .results h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 24px;
            text-align: center;
        }

        .results-header {
            background: #667eea;
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
        }

        .results-header p {
            margin: 5px 0;
        }

        .dimensions {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .dimension-item {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }

        .dimension-item label {
            color: #666;
            font-size: 14px;
            margin-bottom: 5px;
        }

        .dimension-item .value {
            font-size: 24px;
            font-weight: bold;
            color: #333;
        }

        .dimension-item .unit {
            font-size: 14px;
            color: #999;
            margin-left: 5px;
        }

        .summary {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
        }

        .summary-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #e0e0e0;
        }

        .summary-item:last-child {
            border-bottom: none;
        }

        .summary-item label {
            color: #666;
            font-weight: 500;
        }

        .summary-item .value {
            font-weight: bold;
            color: #333;
        }

        .error {
            color: #e74c3c;
            background: #fee;
            padding: 12px;
            border-radius: 8px;
            margin-top: 10px;
            display: none;
        }

        .error.show {
            display: block;
        }

        .diagram-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            overflow-x: auto;
        }

        .diagram-title {
            text-align: center;
            color: #333;
            margin-bottom: 15px;
            font-weight: 600;
        }


        #antennaDiagram {
            width: 100%;
            height: 600px;
            display: block;
        }

        .diagram-grid {
            fill: none;
            stroke: #e0e0e0;
            stroke-width: 0.5;
        }

        .antenna-outline {
            fill: none;
            stroke: #4a90e2;
            stroke-width: 2;
        }

        .antenna-internal {
            fill: none;
            stroke: #4a90e2;
            stroke-width: 1.5;
            stroke-dasharray: 3,2;
        }

        .centerline {
            stroke: #e74c3c;
            stroke-width: 2;
            stroke-dasharray: 5,3;
        }

        .dimension-line {
            stroke: #333;
            stroke-width: 1;
        }

        .dimension-text {
            font-family: Arial, sans-serif;
            font-size: 14px;
            font-weight: 600;
            fill: #333;
            text-anchor: middle;
        }

        .feedpoint {
            fill: #e74c3c;
            stroke: #333;
            stroke-width: 1;
        }

        @media (max-width: 600px) {
            .container {
                padding: 20px;
            }

            .dimensions {
                grid-template-columns: 1fr;
            }

            .diagram-container {
                padding: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Moxon Antenna Calculator</h1>
        <p class="subtitle">Calculate Moxon antenna dimensions</p>
        <p class="source-link">
            Based on <a href="https://makerworld.com/ru/models/1925186-moxon-antenna-868-mhz-wall-desk-mount#profileId-2066038" target="_blank" rel="noopener noreferrer">MakerWorld Model</a>
        </p>
        <p class="source-link">
            Note: Verified only at 868 MHz
        </p>

        <form id="calculatorForm">
            <div class="form-group">
                <label for="frequency">Frequency (MHz):</label>
                <input type="number" id="frequency" name="frequency" step="0.1" min="0.1" required>
            </div>

            <div class="form-group">
                <label>Conductor diameter format:</label>
                <div class="radio-group">
                    <div class="radio-option">
                        <input type="radio" id="dMode1" name="dMode" value="1" checked>
                        <label for="dMode1">Millimeters (mm)</label>
                    </div>
                    <div class="radio-option">
                        <input type="radio" id="dMode2" name="dMode" value="2">
                        <label for="dMode2">Inches (in)</label>
                    </div>
                    <div class="radio-option">
                        <input type="radio" id="dMode3" name="dMode" value="3">
                        <label for="dMode3">AWG</label>
                    </div>
                </div>
            </div>

            <div class="form-group" id="diameterGroup">
                <label for="diameter" id="diameterLabel">Diameter (mm):</label>
                <input type="number" id="diameter" name="diameter" step="0.001" min="0.001" required>
            </div>

            <div class="form-group">
                <label>Output units:</label>
                <div class="radio-group">
                    <div class="radio-option">
                        <input type="radio" id="outMode1" name="outMode" value="1" checked>
                        <label for="outMode1">Millimeters (mm)</label>
                    </div>
                    <div class="radio-option">
                        <input type="radio" id="outMode2" name="outMode" value="2">
                        <label for="outMode2">Inches (in)</label>
                    </div>
                </div>
            </div>

            <div class="error" id="errorMessage"></div>

            <button type="submit">Calculate</button>
        </form>

        <div class="results" id="results">
            <div class="results-header">
                <h2>MOXON ANTENNA DIMENSIONS</h2>
                <p id="resultFrequency"></p>
                <p id="resultDiameter"></p>
                <p id="resultCrossSection"></p>
            </div>

            <div class="diagram-container">
                <div class="diagram-title">Antenna Diagram</div>
                <svg id="antennaDiagram" viewBox="0 0 1400 700" xmlns="http://www.w3.org/2000/svg">
                    <!-- Grid background -->
                    <defs>
                        <pattern id="grid" width="20" height="20" patternUnits="userSpaceOnUse">
                            <path class="diagram-grid" d="M 20 0 L 0 0 0 20"/>
                        </pattern>
                    </defs>
                    <rect width="100%" height="100%" fill="url(#grid)" opacity="0.3"/>
                    
                    <!-- Antenna elements will be drawn here by JavaScript -->
                </svg>
            </div>

            <div class="dimensions">
                <div class="dimension-item">
                    <label>Dimension A</label>
                    <div class="value" id="resultA"></div>
                </div>
                <div class="dimension-item">
                    <label>Dimension B</label>
                    <div class="value" id="resultB"></div>
                </div>
                <div class="dimension-item">
                    <label>Dimension C (Gap)</label>
                    <div class="value" id="resultC"></div>
                </div>
                <div class="dimension-item">
                    <label>Dimension D</label>
                    <div class="value" id="resultD"></div>
                </div>
                <div class="dimension-item" style="grid-column: 1 / -1;">
                    <label>Dimension E</label>
                    <div class="value" id="resultE"></div>
                </div>
            </div>

            <div class="summary">
                <div class="summary-item">
                    <label>Total Wire Length:</label>
                    <span class="value" id="resultTotalLength"></span>
                </div>
                <div class="summary-item">
                    <label>Estimated Impedance:</label>
                    <span class="value" id="resultImpedance"></span>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Helper converters
        function awgToMm(awg) {
            return 0.127 * Math.pow(92, (36 - awg) / 39);
        }

        function mmToInch(mm) {
            return mm / 25.4;
        }

        function inchToMm(inch) {
            return inch * 25.4;
        }

        function mmToCrossSection(diameter) {
            return Math.PI * Math.pow(diameter / 2, 2);
        }

        /**
         * Shortening factor (k) calculation
         * Based on the ratio of wavelength to diameter (M = lambda/d)
         */
        function getShorteningFactor(fMHz, d_mm) {
            const lambda_mm = 299792 / fMHz;
            const M = lambda_mm / d_mm;
            
            if (M <= 2) return 0.9; 
            return 1 - (0.025 / Math.log10(M));
        }

        // MOXON CORE CALCULATION
        function calcMoxon(fMHz, d_mm) {
            const lambda = 299792 / fMHz; 
            
            // Reference values: 868 MHz with 1.5mm wire
            const fRef = 868;
            const dRef = 1.5;
            const lambdaRef = 299792 / fRef;

            const kRef = getShorteningFactor(fRef, dRef);
            const kTarget = getShorteningFactor(fMHz, d_mm);
            const kCorr = kTarget / kRef;

            // Geometric coefficients relative to reference wavelength
            const kA = 124.00 / lambdaRef;
            const kB = 8.5 / lambdaRef;
            const kC = 18.0 / lambdaRef;
            const kD = 19.5 / lambdaRef;
            const kE = 46.00 / lambdaRef;

            return {
                A: kA * lambda * kCorr,
                B: kB * lambda * kCorr,
                C: kC * lambda * kCorr,
                D: kD * lambda * kCorr,
                E: kE * lambda * kCorr,
                Z: 50 * (kTarget / kRef),
                area: mmToCrossSection(d_mm)
            };
        }

        // Function to draw antenna diagram
        function drawAntennaDiagram(A, B, C, D, E, unit) {
            const svg = document.getElementById('antennaDiagram');
            svg.innerHTML = ''; // Clear previous drawing
            
            // Use viewBox dimensions for calculations (SVG will scale automatically)
            const viewBox = svg.viewBox.baseVal;
            const svgWidth = viewBox.width || 1400;
            const svgHeight = viewBox.height || 700;
            
            // Add grid pattern
            const defs = document.createElementNS('http://www.w3.org/2000/svg', 'defs');
            const pattern = document.createElementNS('http://www.w3.org/2000/svg', 'pattern');
            pattern.setAttribute('id', 'grid');
            pattern.setAttribute('width', '20');
            pattern.setAttribute('height', '20');
            pattern.setAttribute('patternUnits', 'userSpaceOnUse');
            const gridPath = document.createElementNS('http://www.w3.org/2000/svg', 'path');
            gridPath.setAttribute('d', 'M 20 0 L 0 0 0 20');
            gridPath.setAttribute('class', 'diagram-grid');
            pattern.appendChild(gridPath);
            defs.appendChild(pattern);
            svg.appendChild(defs);
            
            const gridRect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
            gridRect.setAttribute('width', '100%');
            gridRect.setAttribute('height', '100%');
            gridRect.setAttribute('fill', 'url(#grid)');
            gridRect.setAttribute('opacity', '0.3');
            svg.appendChild(gridRect);
            
            // Scale factors - convert to mm for scaling, then scale to viewBox
            const A_mm = unit === 'in' ? A * 25.4 : A;
            const B_mm = unit === 'in' ? B * 25.4 : B;
            const C_mm = unit === 'in' ? C * 25.4 : C;
            const D_mm = unit === 'in' ? D * 25.4 : D;
            const E_mm = unit === 'in' ? E * 25.4 : E;
            
            // Calculate margins as percentage of SVG size
            const marginPercent = 0.15; // 15% margin on each side
            const marginLeft = svgWidth * marginPercent;
            const marginRight = svgWidth * marginPercent;
            const marginTop = svgHeight * marginPercent;
            const marginBottom = svgHeight * marginPercent;
            
            // Available drawing area
            const drawWidth = svgWidth - marginLeft - marginRight;
            const drawHeight = svgHeight - marginTop - marginBottom;
            
            // Scale to fit - use A and E as reference, leave space for dimension labels
            const scaleX = drawWidth / (A_mm * 1); // Add 300% margin for labels
            const scaleY = drawHeight / (E_mm * 1); // Add 300% margin for vertical labels
            const scale = Math.min(scaleX, scaleY);
            
            const startX = marginLeft;
            const startY = marginTop;
            
            // Draw main rectangle outline (rounded corners)
            const mainRect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
            mainRect.setAttribute('x', startX);
            mainRect.setAttribute('y', startY);
            mainRect.setAttribute('width', A_mm * scale);
            mainRect.setAttribute('height', E_mm * scale);
            mainRect.setAttribute('rx', '5');
            mainRect.setAttribute('ry', '5');
            mainRect.setAttribute('class', 'antenna-outline');
            mainRect.setAttribute('fill', 'none');
            svg.appendChild(mainRect);
            
            // Draw internal horizontal lines
            const topLine = document.createElementNS('http://www.w3.org/2000/svg', 'line');
            topLine.setAttribute('x1', startX);
            topLine.setAttribute('y1', startY + B_mm * scale);
            topLine.setAttribute('x2', startX + A_mm * scale);
            topLine.setAttribute('y2', startY + B_mm * scale);
            topLine.setAttribute('class', 'antenna-internal');
            svg.appendChild(topLine);
            
            const bottomLine = document.createElementNS('http://www.w3.org/2000/svg', 'line');
            bottomLine.setAttribute('x1', startX);
            bottomLine.setAttribute('y1', startY + (B_mm + C_mm) * scale);
            bottomLine.setAttribute('x2', startX + A_mm * scale);
            bottomLine.setAttribute('y2', startY + (B_mm + C_mm) * scale);
            bottomLine.setAttribute('class', 'antenna-internal');
            svg.appendChild(bottomLine);
            
            // Draw center vertical line (divides into two sections)
            const centerVerticalLine = document.createElementNS('http://www.w3.org/2000/svg', 'line');
            centerVerticalLine.setAttribute('x1', startX + (A_mm * scale) / 2);
            centerVerticalLine.setAttribute('y1', startY);
            centerVerticalLine.setAttribute('x2', startX + (A_mm * scale) / 2);
            centerVerticalLine.setAttribute('y2', startY + E_mm * scale);
            centerVerticalLine.setAttribute('class', 'antenna-internal');
            svg.appendChild(centerVerticalLine);
            
            // Draw dimension lines and labels
            // Dimension A (top)
            const dimA1 = document.createElementNS('http://www.w3.org/2000/svg', 'line');
            dimA1.setAttribute('x1', startX);
            dimA1.setAttribute('y1', startY - 50);
            dimA1.setAttribute('x2', startX);
            dimA1.setAttribute('y2', startY - 15);
            dimA1.setAttribute('class', 'dimension-line');
            svg.appendChild(dimA1);
            
            const dimA2 = document.createElementNS('http://www.w3.org/2000/svg', 'line');
            dimA2.setAttribute('x1', startX + A_mm * scale);
            dimA2.setAttribute('y1', startY - 50);
            dimA2.setAttribute('x2', startX + A_mm * scale);
            dimA2.setAttribute('y2', startY - 15);
            dimA2.setAttribute('class', 'dimension-line');
            svg.appendChild(dimA2);
            
            const dimA3 = document.createElementNS('http://www.w3.org/2000/svg', 'line');
            dimA3.setAttribute('x1', startX);
            dimA3.setAttribute('y1', startY - 50);
            dimA3.setAttribute('x2', startX + A_mm * scale);
            dimA3.setAttribute('y2', startY - 50);
            dimA3.setAttribute('class', 'dimension-line');
            svg.appendChild(dimA3);
            
            const textA = document.createElementNS('http://www.w3.org/2000/svg', 'text');
            textA.setAttribute('x', startX + (A_mm * scale) / 2);
            textA.setAttribute('y', startY - 60);
            textA.setAttribute('class', 'dimension-text');
            textA.textContent = `A: ${A.toFixed(2)} ${unit}`;
            svg.appendChild(textA);
            
            // Dimension E (right side)
            const dimE1 = document.createElementNS('http://www.w3.org/2000/svg', 'line');
            dimE1.setAttribute('x1', startX + A_mm * scale + 60);
            dimE1.setAttribute('y1', startY);
            dimE1.setAttribute('x2', startX + A_mm * scale + 15);
            dimE1.setAttribute('y2', startY);
            dimE1.setAttribute('class', 'dimension-line');
            svg.appendChild(dimE1);
            
            const dimE2 = document.createElementNS('http://www.w3.org/2000/svg', 'line');
            dimE2.setAttribute('x1', startX + A_mm * scale + 60);
            dimE2.setAttribute('y1', startY + E_mm * scale);
            dimE2.setAttribute('x2', startX + A_mm * scale + 15);
            dimE2.setAttribute('y2', startY + E_mm * scale);
            dimE2.setAttribute('class', 'dimension-line');
            svg.appendChild(dimE2);
            
            const dimE3 = document.createElementNS('http://www.w3.org/2000/svg', 'line');
            dimE3.setAttribute('x1', startX + A_mm * scale + 60);
            dimE3.setAttribute('y1', startY);
            dimE3.setAttribute('x2', startX + A_mm * scale + 60);
            dimE3.setAttribute('y2', startY + E_mm * scale);
            dimE3.setAttribute('class', 'dimension-line');
            svg.appendChild(dimE3);
            
            const textE = document.createElementNS('http://www.w3.org/2000/svg', 'text');
            textE.setAttribute('x', startX + A_mm * scale + 75);
            textE.setAttribute('y', startY + (E_mm * scale) / 2);
            textE.setAttribute('class', 'dimension-text');
            textE.setAttribute('writing-mode', 'tb');
            textE.textContent = `E: ${E.toFixed(2)} ${unit}`;
            svg.appendChild(textE);
            
            // Dimension B (left side, top)
            const dimB1 = document.createElementNS('http://www.w3.org/2000/svg', 'line');
            dimB1.setAttribute('x1', startX - 90);
            dimB1.setAttribute('y1', startY);
            dimB1.setAttribute('x2', startX - 40);
            dimB1.setAttribute('y2', startY);
            dimB1.setAttribute('class', 'dimension-line');
            svg.appendChild(dimB1);
            
            const dimB2 = document.createElementNS('http://www.w3.org/2000/svg', 'line');
            dimB2.setAttribute('x1', startX - 90);
            dimB2.setAttribute('y1', startY + B_mm * scale);
            dimB2.setAttribute('x2', startX - 40);
            dimB2.setAttribute('y2', startY + B_mm * scale);
            dimB2.setAttribute('class', 'dimension-line');
            svg.appendChild(dimB2);
            
            const dimB3 = document.createElementNS('http://www.w3.org/2000/svg', 'line');
            dimB3.setAttribute('x1', startX - 90);
            dimB3.setAttribute('y1', startY);
            dimB3.setAttribute('x2', startX - 90);
            dimB3.setAttribute('y2', startY + B_mm * scale);
            dimB3.setAttribute('class', 'dimension-line');
            svg.appendChild(dimB3);
            
            const textB = document.createElementNS('http://www.w3.org/2000/svg', 'text');
            textB.setAttribute('x', startX - 105);
            textB.setAttribute('y', startY + (B_mm * scale) / 2);
            textB.setAttribute('class', 'dimension-text');
            textB.setAttribute('writing-mode', 'tb');
            textB.textContent = `B: ${B.toFixed(2)} ${unit}`;
            svg.appendChild(textB);
            
            // Dimension C (left side, middle - Gap)
            const dimC1 = document.createElementNS('http://www.w3.org/2000/svg', 'line');
            dimC1.setAttribute('x1', startX - 90);
            dimC1.setAttribute('y1', startY + B_mm * scale);
            dimC1.setAttribute('x2', startX - 40);
            dimC1.setAttribute('y2', startY + B_mm * scale);
            dimC1.setAttribute('class', 'dimension-line');
            svg.appendChild(dimC1);
            
            const dimC2 = document.createElementNS('http://www.w3.org/2000/svg', 'line');
            dimC2.setAttribute('x1', startX - 90);
            dimC2.setAttribute('y1', startY + (B_mm + C_mm) * scale);
            dimC2.setAttribute('x2', startX - 40);
            dimC2.setAttribute('y2', startY + (B_mm + C_mm) * scale);
            dimC2.setAttribute('class', 'dimension-line');
            svg.appendChild(dimC2);
            
            const dimC3 = document.createElementNS('http://www.w3.org/2000/svg', 'line');
            dimC3.setAttribute('x1', startX - 90);
            dimC3.setAttribute('y1', startY + B_mm * scale);
            dimC3.setAttribute('x2', startX - 90);
            dimC3.setAttribute('y2', startY + (B_mm + C_mm) * scale);
            dimC3.setAttribute('class', 'dimension-line');
            svg.appendChild(dimC3);
            
            const textC = document.createElementNS('http://www.w3.org/2000/svg', 'text');
            textC.setAttribute('x', startX - 105);
            textC.setAttribute('y', startY + B_mm * scale + (C_mm * scale) / 2);
            textC.setAttribute('class', 'dimension-text');
            textC.setAttribute('writing-mode', 'tb');
            textC.textContent = `C: ${C.toFixed(2)} ${unit}`;
            svg.appendChild(textC);
            
            // Dimension D (left side, bottom)
            const dimD1 = document.createElementNS('http://www.w3.org/2000/svg', 'line');
            dimD1.setAttribute('x1', startX - 90);
            dimD1.setAttribute('y1', startY + (B_mm + C_mm) * scale);
            dimD1.setAttribute('x2', startX - 40);
            dimD1.setAttribute('y2', startY + (B_mm + C_mm) * scale);
            dimD1.setAttribute('class', 'dimension-line');
            svg.appendChild(dimD1);
            
            const dimD2 = document.createElementNS('http://www.w3.org/2000/svg', 'line');
            dimD2.setAttribute('x1', startX - 90);
            dimD2.setAttribute('y1', startY + E_mm * scale);
            dimD2.setAttribute('x2', startX - 40);
            dimD2.setAttribute('y2', startY + E_mm * scale);
            dimD2.setAttribute('class', 'dimension-line');
            svg.appendChild(dimD2);
            
            const dimD3 = document.createElementNS('http://www.w3.org/2000/svg', 'line');
            dimD3.setAttribute('x1', startX - 90);
            dimD3.setAttribute('y1', startY + (B_mm + C_mm) * scale);
            dimD3.setAttribute('x2', startX - 90);
            dimD3.setAttribute('y2', startY + E_mm * scale);
            dimD3.setAttribute('class', 'dimension-line');
            svg.appendChild(dimD3);
            
            const textD = document.createElementNS('http://www.w3.org/2000/svg', 'text');
            textD.setAttribute('x', startX - 105);
            textD.setAttribute('y', startY + (B_mm + C_mm) * scale + (D_mm * scale) / 2);
            textD.setAttribute('class', 'dimension-text');
            textD.setAttribute('writing-mode', 'tb');
            textD.textContent = `D: ${D.toFixed(2)} ${unit}`;
            svg.appendChild(textD);
        }

        // Update diameter input label based on selected mode
        const dModeInputs = document.querySelectorAll('input[name="dMode"]');
        const diameterLabel = document.getElementById('diameterLabel');
        const diameterInput = document.getElementById('diameter');

            dModeInputs.forEach(input => {
                input.addEventListener('change', function() {
                    if (this.value === '1') {
                        diameterLabel.textContent = 'Diameter (mm):';
                        diameterInput.step = '0.001';
                    } else if (this.value === '2') {
                        diameterLabel.textContent = 'Diameter (inches):';
                        diameterInput.step = '0.001';
                    } else if (this.value === '3') {
                        diameterLabel.textContent = 'AWG number:';
                        diameterInput.step = '1';
                    }
                });
            });

        // Form submission handler
        document.getElementById('calculatorForm').addEventListener('submit', function(e) {
            e.preventDefault();

            const errorDiv = document.getElementById('errorMessage');
            errorDiv.classList.remove('show');

            // Get inputs
            const fMHz = parseFloat(document.getElementById('frequency').value);
            const dMode = document.querySelector('input[name="dMode"]:checked').value;
            const diameter = parseFloat(document.getElementById('diameter').value);
            const outMode = document.querySelector('input[name="outMode"]:checked').value;

            // Validate frequency
            if (isNaN(fMHz) || fMHz <= 0) {
                errorDiv.textContent = 'Error: Frequency must be a positive number.';
                errorDiv.classList.add('show');
                return;
            }

            // Convert diameter to mm
            let d_mm;
            if (dMode === '1') {
                if (isNaN(diameter) || diameter <= 0) {
                    errorDiv.textContent = 'Error: Diameter must be a positive number.';
                    errorDiv.classList.add('show');
                    return;
                }
                d_mm = diameter;
            } else if (dMode === '2') {
                if (isNaN(diameter) || diameter <= 0) {
                    errorDiv.textContent = 'Error: Diameter must be a positive number.';
                    errorDiv.classList.add('show');
                    return;
                }
                d_mm = inchToMm(diameter);
            } else if (dMode === '3') {
                const awg = parseInt(diameter, 10);
                if (isNaN(awg) || awg < 0 || awg > 40) {
                    errorDiv.textContent = 'Error: AWG must be a number between 0 and 40.';
                    errorDiv.classList.add('show');
                    return;
                }
                d_mm = awgToMm(awg);
            }

            // Calculate
            let res = calcMoxon(fMHz, d_mm);
            
            // Save original values in mm for diagram scaling
            const res_mm = {
                A: res.A,
                B: res.B,
                C: res.C,
                D: res.D,
                E: res.E
            };

            // Unit conversion for output
            let unit = 'mm';
            if (outMode === '2') {
                unit = 'in';
                res.A = mmToInch(res.A);
                res.B = mmToInch(res.B);
                res.C = mmToInch(res.C);
                res.D = mmToInch(res.D);
                res.E = mmToInch(res.E);
            }

            // Calculate total wire length
            const totalWireLength = 2 * res.A + 2 * res.B + 2 * res.D;

            // Display results
            document.getElementById('resultFrequency').textContent = `Frequency: ${fMHz} MHz`;
            document.getElementById('resultDiameter').textContent = `Wire Diameter: ${d_mm.toFixed(3)} mm`;
            document.getElementById('resultCrossSection').textContent = `Wire Cross-section: ${res.area.toFixed(3)} mmÂ²`;

            document.getElementById('resultA').innerHTML = `${res.A.toFixed(2)} <span class="unit">${unit}</span>`;
            document.getElementById('resultB').innerHTML = `${res.B.toFixed(2)} <span class="unit">${unit}</span>`;
            document.getElementById('resultC').innerHTML = `${res.C.toFixed(2)} <span class="unit">${unit}</span>`;
            document.getElementById('resultD').innerHTML = `${res.D.toFixed(2)} <span class="unit">${unit}</span>`;
            document.getElementById('resultE').innerHTML = `${res.E.toFixed(2)} <span class="unit">${unit}</span>`;

            document.getElementById('resultTotalLength').textContent = `${totalWireLength.toFixed(2)} ${unit}`;
            document.getElementById('resultImpedance').textContent = `~${res.Z.toFixed(1)} Ohm`;

            // Store values for redrawing when scale changes
            window.lastDiagramValues = { A: res.A, B: res.B, C: res.C, D: res.D, E: res.E, unit: unit };
            
            // Draw antenna diagram (pass displayed values, function will convert to mm for scaling)
            drawAntennaDiagram(res.A, res.B, res.C, res.D, res.E, unit);

            // Show results
            document.getElementById('results').classList.add('show');

            // Scroll to results
            document.getElementById('results').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        });

    </script>
</body>
</html>

